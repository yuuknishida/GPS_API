<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

        <title>GPS Tracker</title>
    </head>
    <body>
        <style>
            /* Layout: header at top, map centered in the remaining view */
            html, body { height: 100%; margin: 0; font-family: sans-serif; }
            body { display: flex; flex-direction: column; }
            header { padding: 16px 0; text-align: center; }
            .map-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; padding: 8px; }
            /* Constrain width for responsiveness, set height using viewport percent */
            #map { width: 90%; max-width: 1200px; height: 70vh; min-height: 400px; }
            @media (max-width: 768px) { #map { width: 96%; height: 60vh; min-height: 320px; } }
        </style>
        <header>
            <h1>GPS Tracker Map</h1>
        </header>
        <div class="map-wrapper">
            <div id="map"></div>
        </div>
        <!-- Leaflet included in head already; avoid duplicate includes -->
        <script>
            var map = L.map('map').setView([0,0], 2);
            var marker = L.marker([0, 0]).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

            var firstUpdate = true;

            function updateMarker() {
                fetch('./gps/latest')
                    .then(response => response.json())
                    .then(data => {
                        var lat = Number(data.latitude);
                        var lng = Number(data.longitude);
                        if (Number.isFinite(lat) && Number.isFinite(lng)) {
                            marker.setLatLng([lat, lng]);
                            marker.bindPopup("Lat: " + lat.toFixed(6) + " Lng: " + lng.toFixed(6));
                            if (firstUpdate) {
                                firstUpdate = false;
                                // Center the map on the marker (correct API call)
                                map.setView([lat, lng], 13);
                                // Fix sizing if the map container was not fully laid out on load
                                setTimeout(function(){ map.invalidateSize(); }, 200);
                                marker.openPopup();
                            } else {
                                // Smoothly pan the map to the new marker position
                                map.panTo([lat, lng]);
                            }
                        }
                    }).catch(err => {
                        console.error('Failed to fetch GPS coordinates: ', err);
                    });
            }

            updateMarker();
            setInterval(updateMarker, 1000);
        </script>
        
    </body>
</html>